var photo,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),commentsArea=document.querySelector("#comments-board"),commentForm=document.querySelector("#comment"),headingControls=document.querySelector("#heading-controls"),nameInput=document.querySelector("#name"),commentInput=document.querySelector("#comment-text"),cameraViewport=document.querySelector("#player"),cameraFilm=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),feedButton=document.querySelector("#feed-btn"),imagePicker=document.querySelector("#image-picker"),controlsArea=document.querySelector("#videoplayer--camera-controls"),pickerArea=document.querySelector("#pick-image"),stopFeed=document.querySelector("#stop-feed"),cameraNotice=document.querySelector("#videoplayer--notice");function initializeMedia(){console.log("[feed.js] Initializing camera..."),"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(o){var a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return a?new Promise(function(e,t){a.call(navigator,o,e,t)}):Promise.reject(new Error("[feed.js] getUserMedia is not supported by this browser."))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){console.log("[feed.js] Accessing camera. Feed should appear now."),cameraViewport.srcObject=e,stopFeed.style.display="inline",feedButton.style.display="none",cameraViewport.style.display="block",captureButton.style.display="inline",cameraNotice.textContent="Access to camera is allowed."}).catch(function(e){console.log("[feed.js] An error has occurred while accessing the camera.",e),controlsArea.style.display="none",pickerArea.style.display="block",cameraNotice.textContent="Access to camera is denied."})}function stopMedia(){cameraViewport.srcObject.getVideoTracks().forEach(function(e){e.stop()}),feedButton.style.display="block",stopFeed.style.display="none",cameraViewport.style.display="none",cameraFilm.style.display="none",captureButton.style.display="none",cameraNotice.textContent="Camera stopped."}function sendNow(){console.log("[feed.js] Sending data directly...");var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("avatar",photo,e+".png"),t.append("timestamp",e),t.append("user",nameInput.value),t.append("txt",commentInput.value),console.log("[feed.js] Logged data from commentData FormData():"),console.log("ID: "+e+" "+t.get("id")),console.log("Avatar File: "+photo+" "+t.get("avatar")),console.log("Timestamp: "+e+" "+t.get("timestamp")),console.log("User: "+nameInput.value+" "+t.get("user")),console.log("Comment Text: "+commentInput.value+" "+t.get("txt")),fetch("https://us-central1-otonokizaka-3a6d9.cloudfunctions.net/storeCommentData",{method:"POST",body:t}).then(function(e){console.log("[feed.js] Data directly sent.",e),toastMessage.textContent="Your comment was sent directly.",serveToast()}).catch(function(e){console.log("[feed.js] Direct send failed. ",e),toastMessage.textContent="Failed to upload comment.",serveToast()})}function clearCommentsArea(){for(console.log("[feed.js] Clearing comments...");commentsArea.hasChildNodes();)console.log("[feed.js] Cleared child node."),commentsArea.removeChild(commentsArea.lastChild)}function createComment(e){var t=document.createElement("div");t.className="comment-post";var o=document.createElement("div");o.className="comment-user-heading",t.appendChild(o);var a=document.createElement("div");a.className="user-photo-container",o.appendChild(a);var n=document.createElement("img");n.className="user-photo",n.src=e.avatar,n.alt="user",a.appendChild(n);var r=document.createElement("div");r.className="user-name-container",o.appendChild(r);var c=document.createElement("a");c.className="user-link",c.textContent=e.user,c.href="#",r.appendChild(c);var s=document.createElement("span");s.className="timestamp",s.textContent=e.timestamp,r.appendChild(s);var i=document.createElement("div");i.className="comment-body",t.appendChild(i);var m=document.createElement("p");m.className="comment-paragraph",m.textContent=e.txt,i.appendChild(m),commentsArea.appendChild(t)}function updateComments(e){clearCommentsArea(),console.log("[feed.js] Updating comments area...");for(var t=0;t<e.length;t++)createComment(e[t])}feedButton.addEventListener("click",initializeMedia),stopFeed.addEventListener("click",stopMedia),captureButton.addEventListener("click",function(e){cameraFilm.style.display="block",cameraViewport.style.display="none",controlsArea.style.display="none",cameraNotice.textContent="Image captured.",cameraFilm.getContext("2d").drawImage(cameraViewport,0,0,cameraFilm.width,cameraViewport.videoHeight/(cameraViewport.videoWidth/cameraFilm.width)),cameraViewport.srcObject.getVideoTracks().forEach(function(e){e.stop()}),photo=dataURItoBlob(cameraFilm.toDataURL())}),imagePicker.addEventListener("change",function(e){photo=e.target.files[0]}),commentForm.addEventListener("submit",function(e){e.preventDefault(),console.log("[feed.js] Submit button was clicked."),toastMessage.textContent="Processing request.",serveToast(),""!==nameInput.value.trim()&&""!==commentInput.value.trim()?(hideCommentSet(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),avatar:photo,timestamp:(new Date).toISOString(),user:nameInput.value,txt:commentInput.value};writeThis("sync-comments",t).then(function(){e.sync.register("llsif-sync-comment"),console.log("[feed.js] Sync task registered.")}).then(function(){console.log("[feed.js] Post saved for later sync."),toastMessage.textContent="Your comment was saved for uploading.",serveToast()}).catch(function(e){console.log("[feed.js] Error has occurred: ",e),toastMessage.textContent="An error has occurred.",serveToast()})}):(toastMessage.textContent="Background sync did not work. Sending your comment now.",serveToast(),sendNow())):alert("All fields are required.")});var source_url="https://otonokizaka-3a6d9.firebaseio.com/comments.json",networkData=!1;fetch(source_url).then(function(e){return e.json()}).then(function(e){networkData=!0,console.log("[feed.js] Received from web: ",e);var t=[];for(var o in e)t.push(e[o]);updateComments(t)}).catch(function(e){console.log("[feed.js]: Error occured: ",e),setTimeout(function(){toastMessage.textContent="Cannot retrieve comments right now.",serveToast()},5e3);var t=document.createElement("div");t.className="comment-post",t.textContent="Attempting to show cached comments.",headingControls.appendChild(t)}),"indexedDB"in window&&readThis("comments").then(function(e){networkData||(console.log("[feed.js] Retrieved from cache (IndexedDB):",e),updateComments(e))});